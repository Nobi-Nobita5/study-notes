**一、消费者和消费者群组**

在 Kafka 中，消费者通常是消费者群组的一部分，多个消费者群组共同读取同一个主题时，彼此之间互不影响。Kafka 之所以要引入消费者群组这个概念是因为 Kafka 消费者经常会做一些高延迟的操作，**比如把数据写到数据库或 HDFS** ，或者进行耗时的计算，在这些情况下，单个消费者无法跟上数据生成的速度。此时可以增加更多的消费者，让它们分担负载，分别处理部分分区的消息，这就是 Kafka 实现横向伸缩的主要手段。

需要注意的是：**同一个分区只能被同一个消费者群组里面的一个消费者读取，不可能存在同一个分区被同一个消费者群里多个消费者共同读取的情况**

<img src="https://springboot-vue-blog.oss-cn-hangzhou.aliyuncs.com/img-for-typora/image-20230404151403503.png" alt="image-20230404151403503" style="zoom:60%;" />

**二、分区再均衡**

因为群组里的消费者共同读取主题的分区，所以当一个消费者被关闭或发生崩溃时，它就离开了群组，原本由它读取的分区将由群组里的其他消费者来读取。同时在主题发生变化时 ， 比如添加了新的分区，也会发生分区与消费者的重新分配，**分区的所有权从一个消费者转移到另一个消费者，这样的行为被称为再均衡**。正是因为再均衡，所以消费费者群组才能保证高可用性和伸缩性。

**消费者（位于kafka集群内部或外部）通过向群组协调器所在的 broker 发送心跳来维持它们和群组的从属关系以及它们对分区的所有权**。只要消费者以正常的时间间隔发送心跳，就被认为是活跃的，说明它还在读取分区里的消息。消费者会在轮询消息或提交偏移量时发送心跳。如果消费者停止发送心跳的时间足够长，会话就会过期，群组协调器认为它已经死亡，就会触发再均衡。

**三、自动提交偏移量**

**3.1 偏移量的重要性**

Kafka 的每一条消息都有一个偏移量属性，记录了其在分区中的位置，偏移量是一个单调递增的整数。消费者通过往一个叫作 `＿consumer_offset` 的特殊主题发送消息，消息里包含每个分区的偏移量。 如果消费者一直处于运行状态，那么偏移量就没有什么别的用处。不过，如果有**消费者退出或者新分区加入，此时就会触发再均衡**。完成再均衡之后，每个消费者可能分配到新的分区，而不是之前处理的那个。为了能够继续之前的工作，消费者需要读取每个分区最后一次提交的偏移量，然后从偏移量指定的地方继续处理。 因为这个原因，所以如果不能正确提交偏移量，就可能会导致数据丢失或者重复出现消费，比如下面情况：

- 如果提交的偏移量小于客户端处理的最后一个消息的偏移量 ，那么处于两个偏移量之间的消息就会被重复消费；
- 如果提交的偏移量大于客户端处理的最后一个消息的偏移量，那么处于两个偏移量之间的消息将会丢失。

**3.2 自动提交偏移量**

自动提交偏移量是指消费者自动将消费的偏移量定期提交给Kafka集群，这个提交的间隔时间可以通过参数 `auto.commit.interval.ms` 来设置，默认值为5000ms。

使用自动提交是存在隐患的，假设我们使用默认的 5s 提交时间间隔，在最近一次提交之后的 3s 发生了再均衡，再均衡之后，消费者从最后一次提交的偏移量位置开始读取消息。这个时候偏移量已经落后了 3s ，所以在这 3s 内到达的消息会被重复处理。可以通过修改提交时间间隔来更频繁地提交偏移量，减小可能出现重复消息的时间窗，不过这种情况是无法完全避免的。基于这个原因，Kafka 也提供了手动提交偏移量的 API，使得用户可以更为灵活的提交偏移量。

**四、手动提交偏移量**

> 提交偏移量的动作，可以由kafka程序控制手动提交。

4.1同步提交

1）消费者可以调用 `consumer.commitSync()` 方法来同步提交消费的偏移量，该方法会**阻塞当前线程直到偏移量提交成功或提交失败抛出异常**。同步提交偏移量的好处是简单易用，可以保证消费的偏移量提交的可靠性。

2）同步提交偏移量的优点在于，可以**保证消费者消费消息的准确性**。如果提交失败，会抛出异常，可以通过异常处理来避免消息丢失的问题。

3）同步提交偏移量的缺点在于，每次提交偏移量都需要等待提交成功或失败的返回，因此会造成一定的**性能损失**，尤其是在消费者处理消息较慢的情况下。

4.2异步提交

1）异步提交偏移量是指消费者在提交偏移量时，不会被阻塞，而是直接返回，提交的结果通过回调函数异步返回。异步提交偏移量的代码如下：

~~~java
consumer.commitAsync(new OffsetCommitCallback() {
    public void onComplete(Map<TopicPartition, OffsetAndMetadata> offsets, Exception e) {
        if (e != null) {
            // 处理提交失败的情况
        }
    }
});
~~~

2）异步提交偏移量的优点在于，提交偏移量的速度更快，不会阻塞消费者处理消息，因此可以**提高消费者的吞吐量**。异步提交可以提高程序的吞吐量，因为此时你可以**尽管请求数据**，而**不用等待 Broker 的响应**。

3）异步提交偏移量的缺点在于，由于是异步提交，**无法保证偏移量提交的可靠性**，可能会导致偏移量丢失或重复消费的问题。如果异步提交偏移量时出现异常，需要通过回调函数的 `onComplete()` 方法处理提交失败的情况。

**五、监听分区再均衡**

**六、推出轮询**

**七、独立的消费者**