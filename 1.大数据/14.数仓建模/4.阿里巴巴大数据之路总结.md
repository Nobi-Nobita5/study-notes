### 数据模型篇总结

#### 一、大数据领域建模综述

1. 为什么要有数据建模

   1）性能

   2）成本

   3）效率

   4）质量

2. 经典的建模理论

   1）范式建模

   2）维度建模

#### 二、数据整合及管理体系

1. 项目建模的价值

   > 建设统一的、规范化的数据接入层（ ODS ）和数据中间层（ DWD 和 DWS ），通过数据服务和数据产品，完成服务于阿里巴巴的大数据系 统建设，即数据公共层建设。

2. 项目建模的体系架构

   > ![image-20230625101343355](https://springboot-vue-blog.oss-cn-hangzhou.aliyuncs.com/img-for-typora/image-20230625101343355.png)
   >
   > 1. 业务板块：根据业务属性划分板块，板块之间的指标或业务重叠性较小。
   >
   > 2. 规范定义：一套数据规范命名体系，用在模型设计中。
   >
   >    > 可以在这个阶段**划分数据域、定义对应的修饰类型和维度、业务过程**
   >
   > 3. 模型设计：以**维度建模理论**为基础，基于维度建模总线架构，构建一致性的维度和事实(进行规范定义)。**这里重点说下事实和维度的构建步骤：**
   >
   >    > - 第一个阶段是**高层模型设计时期** ，定义业务过程维度模型的范围，提供每种星形模式的技术和功能描述；直接产出目标是创建高层维度模型图，它是对业务过程中的维表和事实表的图形描述。**确定维表创建初始属性列表，为每个事实表创建提议度量**；
   >    >
   >    > - 第二个阶段是**详细模型设计时期**，对每个星形模型添加属性和度量信息；**确定每个维表的属性和每个事实表的度量**，并确定信息来源的位置、定义，确定属性和度量如何填入模型的初步业务规则。
   >    >
   >    > - 第三个阶段是进行**模型的审查、再设计和验证**，本阶段主要召集相关人员进行模型的审查和验证，根据审查结果对详细维度进行再设计。
   >    >
   >    >   **根据派生指标+维度属性生成汇总事实表，根据原子指标(度量)+维度属性生成明细事实表。**
   >    >
   >    > - 第四个阶段是**产生详细设计文档**，提交 ETL 设计和开发，最后，完成模型详细设计文档，提交 ETL 开发人员，进入 ETL 设计和开发阶段，由 ETL 人员完成物理模型的设计和开发。

3. 派生指标可以分为三类：事务型指标、存量型指标和复合型指标。

   - 事务型指标：是指对业务活动进行衡量的指标。例如新发商品数、 重发商品数、新增注册会员数、订单支付金额，这类指标需维护 原子指标及修饰词，在此基础上创建派生指标。
   - 存量型指标：是指对实体对象(如商品、会员)某些状态的统计。例如商品总数、注册会员总数，这类指标需维护原子指标及修饰词，在此基础上创建派生指标，对应的时间周期 一般为“历史截至当前某个时间”。
   - 复合型指标：是在事务型指标和存量型指标的基础上复合而成的。例如浏览 UV-下单买家数转化率 ， 有些需要 创 建新原子指标， 有些则可以在事务型或存量型原子指标的基础上增加修饰词得到派生指标。

#### 三、维度设计

1. 维度设计基本概念

   1）维度所包含的表示维度的列，称为维度属性

   2）维度使用主键标识其唯一性

2. 维度的基本设计方法

   1. **选择维度或新建维度**。须保证维度的唯一性。
   2. **确定主维表**。一般是ODS表，直接与业务系统同步。
   3. **确定相关维表**。确定哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。
   4. **确定维度属性**。第一阶段从主维表中选择维度属性或生成新的维度属性；第二阶段是从相关维表中选择维度属性或生成新的维度属性。

3. 处理缓慢变化维的方式

   1. 重写维度值。不保留历史数据， 始终取最新数据（假设业务需求方不关心历史数据，则可以采用方案1）
   2. 插入新的维度行。保留历史数据，维度值变化前的事实和过去的维度值关联，维度值变化后的事实和当前的维度值关联。
   3. 添加维度列。采用第二种处理方式不能将变化前后记录的事实归一为变化前的维度或者归一为变化后的维度（不同业务部门需要统计各自的业绩，则需 要保留历史数据）

4. 快照维表

   - 在 Kimball 的维度建模中，必须使用代理键（不具有业务含义的键，区别于自然键）作为每个维表的主键，用于处理缓慢变化维。
   - 阿里不使用代理键的原因：数据量大、ETL复杂化；不直接使用拉链表的原因：解释成本高、随着时间的推移，分区数量会极度膨胀
   - 阿里通过快照方式，每天保留一份全量快照数据，简单而有效，方便好理解，但造成存储浪费，因此配合极限存储。

#### 四、事实表设计

1. 基本概念

   1）度量

   2）粒度

   3）**退化维度**：存储到事实表中的维度列

2. 事实表有三种类型 : **事务事实表、周期快照事实表和累积快照事实表**。

   - 事务事实表用来描述业务过程，跟踪空间或时间上某点的度量事件，保存的是最原子的数据，也称为“原子事实表“。
   - 周期快照事实表以具有规律性的、可预见的时间间隔记录事实 ，时间间隔如每天、每月、每年等。
   - 累积快照事实表用来表述过程开始和结束之间的关键步骤事件，覆盖过程的整个生命周期，通常具有多个日期字段来记录关键时间点，当过程随着生命周期不断变化时，记录也会随着过程的变化而被修改。
   
2. 事实表设计原则

   > 原则 1：尽可能包含所有与**业务过程相关的事实**
   >
   > 原则 2：只选择与业务过程相关的事实
   >
   > 原则 3：**分解不可加性事实为可加的组件**
   >
   > ​				比如订单的优惠率，应该分解为订单原价金额与订单优惠金额两个事实存储在事实表中。
   >
   > 原则 4：**在选择维度和事实之前必须先声明粒度**
   >
   > 原则 5：在同一个事实表中不能有多种不同粒度的事实
   >
   > 原则 6：**事实的单位要保持一致**
   >
   > ​				比如原订单金额、 订单优惠金额、订单运费金额这三个事实，应该采用一致的计量单位， 统 一 为元或分，以方便使用。
   >
   > 原则 7：对事实的 null 值要处理
   >
   > 原则 8：**使用退化维度提高事实表的易用性**
   
3. 事实表设计步骤
   
   1）选择业务过程
   
   2）声明粒度
   
   3）确定维度
   
   4）确定事实
   
   