##### 一、es简介

**1. es的索引结构、数据存储结构**

倒排索引：https://blog.csdn.net/Diamond_Tao/article/details/122146194

​		FST存储在堆内存，通过建立FST这个二级索引，可以实现倒排索引的快速定位，不需要经过多次的磁盘IO，搜索效率大大提高了。

正排索引 Doc Value 列式存储: https://blog.csdn.net/qq_35423154/article/details/119524658

​		在Elasticsearch中，Doc Values就是一种列式存储结构，**在索引（此处为动词，表示数据写入）时与倒排索引同时生成**。也就是说Doc Values和倒排索引一样，【基于 Segement生成并且是不可变的】。同时Doc Values和倒排索引一样序列化到磁盘。

> 下面举一个例子，来讲讲它是如何运作的:
>
> 假设存在以下倒排索引
>
> ~~~
> Term      Doc_1   Doc_2   Doc_3
> ------------------------------------
> brown   |   X   |   X   |
> dog     |   X   |       |   X
> dogs    |       |   X   |   X
> ------------------------------------
> ~~~
>
> 那么其生成的DocValues如下（实际存储时不会存储doc_id，值所在的顺位即为doc_id）
>
> ~~~
> Doc_id    Values   
> ------------------
> Doc_1    | brown |  
> Doc_1    | dog   |  
> Doc_2    | brown |  
> Doc_2    | dogs  |     
> Doc_3    | dog   |
> Doc_3    | dogs  | 
> ------------------
> ~~~
>
> 假设我们需要计算出brown出现的次数
>
> ~~~
> GET /my_index/_search
> {
>     "query":{
>         "match":{
>             "body":"brown"
>         }
>     },
>     "aggs":{
>         "popular_terms":{
>             "terms":{
>                 "field":"body"
>             }
>         }
>     },
>    "size" : 0
> }
> ~~~
>
> 上述请求由以下两步实现：
>
> 1. 定位数据范围。通过倒排索引，来找到所有包含brown的doc_id。
> 2. 进行聚合计算。借助doc_id在doc_values中定位到为brown的字段，此时进行聚合累加得到计算结果。brown的count=2。

##### 2. B+树为什么不适合全文索引？

​		全文索引需要搜索文本中的词语，而不仅仅是特定的关键字。这意味着在全文索引中，需要将文本拆分成单词，而且这些单词的位置信息也很重要。相比之下，B+树只能处理固定长度的关键字，而无法直接处理变长的单词或者跨越多个单词的短语。

​		为了解决这个问题，可以使用倒排索引（Inverted Index）来实现全文索引。倒排索引可以将文本中的每个单词都记录下来，并记录每个单词在文本中出现的位置。这样，用户就可以在查询时指定多个关键字，而不用关心它们的位置关系。倒排索引的结构更加适合于全文索引，因为它可以轻松地处理变长的单词和短语。

##### 二、Elasticsearch DSL

DSL 全称 Domain Specific language，即特定领域专用语言。

##### 1）对数据的基本操作

1. 对索引的增删改查，分词查询，过滤（值等）查询，分页查询，排序，高亮，聚合

2. 支持SQL的使用

~~~shell
# es 在存储字符串时，都会保留两种方式存储：text 和 keyword
# 一种是倒排索引方式(text 类型)，用于分词匹配。
# 一种是正排索引 标准列式存储(keyword 类型)，用于过滤 ，分组，聚合，排序…. ，需要加 keyword。
~~~

##### 2）中文分词

​	ES默认对中文按字分词，需要安装ik分词插件，然后可以在创建索引时指定分词方式。ik_smart、ik_max_word。

##### 3）其他

1. mapping存放index中各field的属性和配置

2. 【ES 不允许对索引结构进行修改】，如果业务发生变化，字段类型需要进行修改，ES 如何 应对呢?

   ​		**分割索引**，根据时间间隔把一个业务索引切分成多个索引。

   ​		**索引别名**，可以为切分的索引取统一的别名，统计时直接指定别名即可。

   ​		**索引模板**，可以让ES在创建索引时，使用我们定义好的模板，模板中可以指定index_patterns(匹配索引名则使用该模板)、setting、aliases、mappings等属性。

   那么如果字段类型需要进行修改，就修改索引模板，让ES根据新的模板创建切分的索引。

##### 三、分布式读写原理

读流程、写流程、搜索流程、Document的操作和并发控制、

删除方式：如果进行删除文档操作，也不会直接物理删除，而是通过给文档打删除标记，进行逻辑 删除，【至到该索引触发段合并时，才物理删除，释放存储空间】、

shard和Segment（shard太多带来的危害、规划shard数量、shard优化、【数据的物理提交流程】、segment优化），其中shard优化和segment优化都可以通过【合并多个segment】实现、

关于master： master 并不负责实际的数据处理，主要是负责对如下信息的维护工作。集群状态；用户参数配置；数据的索引、别名、分析器的相关设置；分片所在节点位置等。虽然这些信息每个节点都有，但是只有 master 节点可以发起变更，然后同步给其他节点。